@inherits LayoutComponentBase
@using MudBlazor
@* Navigation injected in code-behind to avoid duplicate symbol *@

<MudThemeProvider Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />
<MudBreakpointProvider>
    <MudLayout Class="mud-layout-full-height finance-layout">
        <MudAppBar Elevation="1" Color="Color.Primary">
            <MudIconButton Icon="@Icons.Material.Filled.Menu"
                           Color="Color.Inherit"
                           Edge="Edge.Start"
                           OnClick="DrawerToggle"
                           Class="desktop-only" />

            <MudIcon Icon="@Icons.Material.Filled.Home" Class="ml-2" />
            <MudText Typo="Typo.h6" Class="ml-2">Meu Financeiro</MudText>

            <MudSpacer />

            <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit" />

            <MudMenu OffsetY="true">
                <ActivatorContent>
                    <MudAvatar Size="Size.Medium" Class="ml-2" Text="@_avatarInitial" />
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem OnClick="GoToProfile">Perfil</MudMenuItem>
                    <MudMenuItem OnClick="Logout">Sair</MudMenuItem>
                </ChildContent>
            </MudMenu>
        </MudAppBar>

        <MudDrawer @bind-Open="_drawerOpen"
                   ClipMode="DrawerClipMode.Always"
                   Elevation="2"
                   Variant="DrawerVariant.Responsive"
                   Breakpoint="Breakpoint.Sm"
                   Class="finance-drawer desktop-only">
            <NavMenu />
        </MudDrawer>

        <MudMainContent Class="mud-main-content-full">
            <MudContainer MaxWidth="MaxWidth.Large" Class="finance-main-container">
                <div class="main-container">
                    @if (!_checkedAuth)
                    {
                        <div style="display:flex;justify-content:center;padding:24px;">
                            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                        </div>
                    }
                    else if (!_isAuthenticated && _currentRelativeUri != "login" && _currentRelativeUri != "auth/register")
                    {
                        <!-- navigation to login is handled in OnInitializedAsync; do not render body -->
                    }
                    else
                    {
                        @Body
                    }
                </div>
            </MudContainer>
        </MudMainContent>

        <!-- Bottom navigation for mobile -->
        <div class="mobile-only bottom-nav-wrapper">
            <BottomNavMenu />
        </div>

        <!-- FAB removed for mobile (center action lives inside bottom nav) -->
    </MudLayout>
</MudBreakpointProvider>

@code {
    private bool _drawerOpen = true;
    private MudTheme _theme = new();
    private bool _checkedAuth = false;
    private bool _isAuthenticated = false;
    private string _currentRelativeUri = string.Empty;
    private string _avatarInitial = "";

    [Inject] public Finance.Mobile.Services.TokenService TokenService { get; set; } = default!;
    [Inject] public NavigationManager Navigation { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // Check authentication once and block rendering until complete
        _currentRelativeUri = Navigation.ToBaseRelativePath(Navigation.Uri).TrimEnd('/');
        var token = await TokenService.GetTokenAsync();
        _isAuthenticated = !string.IsNullOrEmpty(token);
        if (_isAuthenticated)
        {
            var name = await TokenService.GetUsernameAsync();
            if (!string.IsNullOrEmpty(name))
            {
                _avatarInitial = name.Trim()[0].ToString().ToUpperInvariant();
            }
        }
        _checkedAuth = true;
        StateHasChanged();

        if (!_isAuthenticated && _currentRelativeUri != "login" && _currentRelativeUri != "auth/register")
        {
            Navigation.NavigateTo("/login");
        }
    }

    private void DrawerToggle() => _drawerOpen = !_drawerOpen;
    private void GoToAddTransaction() => Navigation.NavigateTo("/transactions/add");
    private void GoToProfile() => Navigation.NavigateTo("/profile");
    private async void Logout()
    {
        await TokenService.RemoveTokenAsync();
        Navigation.NavigateTo("/login");
    }
}
