@inherits LayoutComponentBase
@implements IDisposable
@using MudBlazor
@using Finance.Domain.Entities
@* Navigation injected in code-behind to avoid duplicate symbol *@

<MudThemeProvider Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />
<MudBreakpointProvider>
    <MudLayout Class="mud-layout-full-height finance-layout">
        <MudAppBar Elevation="1" Color="Color.Primary" Dense="true" Class="finance-top-appbar">
            @if (_isAuthenticated)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Menu"
                               Color="Color.Inherit"
                               Edge="Edge.Start"
                               OnClick="DrawerToggle"
                               Class="desktop-only" />

                <MudSelect T="int?"
                           Value="AccountState.SelectedAccountId"
                           ValueChanged="OnAccountChanged"
                           Dense="true"
                           Variant="Variant.Text"
                           Class="ml-3 account-selector"
                           Placeholder="Selecionar conta"
                           AdornmentIcon="@Icons.Material.Filled.AccountBalance"
                           Adornment="Adornment.Start"
                           Disabled="@(!AccountState.Accounts.Any())"
                           ToStringFunc="GetAccountDisplayName">
                    @foreach (var account in AccountState.Accounts)
                    {
                        <MudSelectItem T="int?" Value="@((int?)account.Id)">@account.Name</MudSelectItem>
                    }
                </MudSelect>
            }

            <MudSpacer />

            @if (_isAuthenticated)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Notifications"
                               Color="Color.Inherit"
                               Class="appbar-icon-button" />

                <MudMenu OffsetY="true">
                    <ActivatorContent>
                        <MudAvatar Size="Size.Medium"
                                   Class="ml-2 avatar-letter"
                                   Color="@AvatarColor">
                                @AvatarLetter
                        </MudAvatar>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem OnClick="GoToProfile">Perfil</MudMenuItem>
                        <MudMenuItem OnClick="Logout">Sair</MudMenuItem>
                    </ChildContent>
                </MudMenu>
            }
        </MudAppBar>

        @if (_isAuthenticated)
        {
            <MudDrawer @bind-Open="_drawerOpen"
                       ClipMode="DrawerClipMode.Always"
                       Elevation="2"
                       Variant="DrawerVariant.Responsive"
                       Breakpoint="Breakpoint.Sm"
                       Class="finance-drawer desktop-only">
                <NavMenu />
            </MudDrawer>
        }

        <MudMainContent Class="mud-main-content-full">
            <MudContainer MaxWidth="MaxWidth.Large" Class="finance-main-container">
                <div class="main-container">
                    @Body
                </div>
            </MudContainer>
        </MudMainContent>

        @if (_isAuthenticated)
        {
            <div class="mobile-only bottom-nav-wrapper">
                <BottomNavMenu />
            </div>
        }
    </MudLayout>
</MudBreakpointProvider>

@code {
    private bool _drawerOpen = true;
    private MudTheme _theme = new();
    private string? _name;
    private bool _isAuthenticated;

    [Inject] public Finance.Mobile.Services.TokenService TokenService { get; set; } = default!;
    [Inject] public Finance.Mobile.Services.FinanceApiClient ApiClient { get; set; } = default!;
    [Inject] public Finance.Mobile.Services.AccountSelectionState AccountState { get; set; } = default!;
    [Inject] public NavigationManager Navigation { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += HandleLocationChanged;
        await RefreshAuthenticationStateAsync();
    }

    private async void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await RefreshAuthenticationStateAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshAuthenticationStateAsync()
    {
        var token = await TokenService.GetTokenAsync();
        var wasAuthenticated = _isAuthenticated;
        _isAuthenticated = !string.IsNullOrWhiteSpace(token);

        var uri = Navigation.ToBaseRelativePath(Navigation.Uri).TrimEnd('/');
        if (!_isAuthenticated && uri != "login" && uri != "auth/register")
        {
            Navigation.NavigateTo("/login");
            return;
        }

        if (_isAuthenticated)
        {
            _name = await TokenService.GetUsernameAsync();
            ApiClient.SetBearerToken(token!);

            if (!wasAuthenticated || !AccountState.Accounts.Any())
            {
                try
                {
                    var accounts = await ApiClient.GetAccountsAsync();
                    AccountState.SetAccounts(accounts);
                }
                catch
                {
                    // no-op
                }
            }
        }
        else
        {
            _name = null;
            AccountState.SetAccounts(Array.Empty<Account>());
            AccountState.SetSelectedAccount(null);
        }
    }

    private Task OnAccountChanged(int? accountId)
    {
        AccountState.SetSelectedAccount(accountId);
        return Task.CompletedTask;
    }


    private string GetAccountDisplayName(int? accountId)
    {
        if (!accountId.HasValue)
            return string.Empty;

        return AccountState.Accounts.FirstOrDefault(a => a.Id == accountId.Value)?.Name ?? string.Empty;
    }

    private string AvatarLetter =>
        string.IsNullOrWhiteSpace(_name)
            ? "?"
            : _name.Trim().Substring(0, 1).ToUpper();

    private Color AvatarColor =>
        string.IsNullOrWhiteSpace(_name)
            ? Color.Default
            : GetColorFromName(_name);

    private Color GetColorFromName(string name)
    {
        var colors = new[]
        {
            Color.Primary,
            Color.Secondary,
            Color.Tertiary,
            Color.Info,
            Color.Success,
            Color.Warning
        };

        var hash = name.GetHashCode();
        return colors[Math.Abs(hash) % colors.Length];
    }

    private void DrawerToggle() => _drawerOpen = !_drawerOpen;
    private void GoToProfile() => Navigation.NavigateTo("/profile");
    private async void Logout()
    {
        await TokenService.RemoveTokenAsync();
        _isAuthenticated = false;
        _name = null;
        AccountState.SetAccounts(Array.Empty<Account>());
        AccountState.SetSelectedAccount(null);
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= HandleLocationChanged;
    }
}
