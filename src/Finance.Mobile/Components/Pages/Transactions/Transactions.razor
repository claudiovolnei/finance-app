@page "/transactions"
@implements IDisposable
@using MudBlazor
@using Finance.Domain.Entities
@using Finance.Mobile.Services
@inject FinanceApiClient ApiClient
@inject NavigationManager Navigation
@inject TokenService TokenService
@inject AccountSelectionState AccountState

<MonthYearNavigator CurrentLabel="@GetCurrentFilterLabel()" OnPrevious="PrevMonth" OnNext="NextMonth" />

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
        <MudText Typo="Typo.h5">Transações</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="NavigateToAdd">
            Nova
        </MudButton>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (_transactions == null || !_transactions.Any())
    {
        <MudAlert Severity="Severity.Info" Dense="true">Nenhuma transação encontrada.</MudAlert>
    }
    else
    {
        <MudPaper Class="pa-4" Elevation="1">
            <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">@_transactions.Count lançamentos no período</MudText>
            <MudList T="Transaction" Dense="true" Class="pa-0">
                @foreach (var tx in _transactions)
                {
                    <MudListItem Class="px-0">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width:100%;">
                            <MudStack Spacing="0" Style="min-width:0;">
                                <MudText Typo="Typo.body2" Class="list-primary-text">@tx.CategoryName</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary list-secondary-text">@tx.Date.ToString("dd/MM/yyyy")</MudText>
                            </MudStack>

                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudChip T="string" Color="@(tx.Type == TransactionType.Income ? Color.Success : Color.Error)" Variant="Variant.Text" Size="Size.Small">
                                    @(tx.Type == TransactionType.Income ? "Crédito" : "Débito")
                                </MudChip>
                                <MudText Typo="Typo.body2" Class="list-value-text" Color="@(tx.Type == TransactionType.Income ? Color.Success : Color.Error)">
                                    @tx.Amount.ToString("C", new System.Globalization.CultureInfo("pt-BR"))
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => NavigateToEdit(tx.Id))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteTransaction(tx.Id))" />
                            </MudStack>
                        </MudStack>
                    </MudListItem>
                    <MudDivider />
                }
            </MudList>
        </MudPaper>
    }

    @if (!string.IsNullOrEmpty(_message))
    {
        <MudAlert Severity="@_alertSeverity" Dense="true" Class="mt-3">@_message</MudAlert>
    }
</MudContainer>

@code {
    private List<TransactionDto>? _transactions;
    private bool _loading = true;
    private string _message = "";
    private Severity _alertSeverity = Severity.Info;
    private int? _filterYear;
    private int? _filterMonth;
    private DateTime _current = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        AccountState.OnChange += HandleGlobalAccountChanged;

        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        ApiClient.SetBearerToken(token);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;

        await LoadTransactions();
    }

    private string GetCurrentFilterLabel() => _current.ToString("MMMM yyyy", new System.Globalization.CultureInfo("pt-BR"));

    private async Task PrevMonth()
    {
        _current = _current.AddMonths(-1);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;
        await LoadTransactions();
    }

    private async Task NextMonth()
    {
        _current = _current.AddMonths(1);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;
        await LoadTransactions();
    }

    private async Task LoadTransactions()
    {
        try
        {
            _loading = true;
            _transactions = await ApiClient.GetTransactionsAsync(_filterYear, _filterMonth, AccountState.SelectedAccountId);
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        catch (Exception ex)
        {
            _message = $"Erro ao carregar transações: {ex.Message}";
            _alertSeverity = Severity.Error;
        }
        finally
        {
            _loading = false;
        }
    }

    private async void NavigateToAdd()
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }
        Navigation.NavigateTo("/transactions/add");
    }

    private void NavigateToEdit(int id)
    {
        _ = EnsureAndNavigateEdit(id);
    }

    private async Task EnsureAndNavigateEdit(int id)
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }
        Navigation.NavigateTo($"/transactions/edit/{id}");
    }

    private async Task DeleteTransaction(int id)
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        try
        {
            await ApiClient.DeleteTransactionAsync(id);
            _message = "Transação excluída com sucesso!";
            _alertSeverity = Severity.Success;
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            _message = $"Erro ao excluir transação: {ex.Message}";
            _alertSeverity = Severity.Error;
        }
    }

    private async void HandleGlobalAccountChanged()
    {
        await LoadTransactions();
    }

    public void Dispose()
    {
        AccountState.OnChange -= HandleGlobalAccountChanged;
    }
}
