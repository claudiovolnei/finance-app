@page "/"

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <MudGrid GutterSize="GutterSize.Small" AlignItems="Center">
        <!-- Top info cards: Saldo full width, Receitas and Despesas side by side on larger screens -->
        <MudItem xs="12" sm="12">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Saldo Atual</MudText>
                <MudText Typo="Typo.h5" Color="Color.Success">@(_summary is null ? "-" : string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", _summary.Balance))</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="6">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Receitas</MudText>
                <MudText Typo="Typo.h5" Color="Color.Primary">@(_summary is null ? "-" : string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", _summary.TotalIncome))</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="6">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Despesas</MudText>
                <MudText Typo="Typo.h5" Color="Color.Error">@(_summary is null ? "-" : string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", _summary.TotalExpense))</MudText>
            </MudPaper>
        </MudItem>

        <!-- Gastos por Categoria (chart placeholder) -->
        <MudItem xs="12" class="mt-3">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.subtitle1">Gastos por Categoria</MudText>
                <div style="height:260px;display:flex;align-items:center;justify-content:center;"> 
                    <MudChart ChartType="ChartType.Pie" Class="w-100" Height="220px" Labels="_chartLabels" Datasets="_chartDatasets" />
                </div>
            </MudPaper>
        </MudItem>

        <!-- Últimos Lançamentos -->
        <MudItem xs="12" class="mt-3">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.subtitle1">Últimos Lançamentos</MudText>
                <div style="overflow:auto;margin-top:8px;">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="text-align:left;border-bottom:1px solid rgba(0,0,0,0.08);">
                                <th style="padding:8px;">Data</th>
                                <th style="padding:8px;">Descrição</th>
                                <th style="padding:8px;">Categoria</th>
                                <th style="padding:8px;">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if (_summary != null)
                        {
                            foreach (var tx in _summary.LatestTransactions)
                            {
                                <tr>
                                    <td style="padding:8px;">@tx.Date.ToString("dd/MM/yyyy")</td>
                                    <td style="padding:8px;">@tx.Description</td>
                                    <td style="padding:8px;">@tx.CategoryName</td>
                                    <td style="padding:8px;">@string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", tx.Amount)</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="4" style="padding:8px;">Carregando...</td></tr>
                        }
                        </tbody>
                    </table>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    [Inject] public FinanceApiClient Api { get; set; } = default!;
    [Inject] public TokenService TokenService { get; set; } = default!;
    [Inject] public NavigationManager Navigation { get; set; } = default!;

    private DashboardSummaryDto? _summary;
    private string[] _chartLabels = Array.Empty<string>();
    private MudBlazor.ChartSeries[] _chartDatasets = Array.Empty<MudBlazor.ChartSeries>();

    protected override async Task OnInitializedAsync()
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }
        Api.SetBearerToken(token);

        try
        {
            var dto = await Api.GetDashboardSummaryAsync();
            if (dto != null)
            {
                _summary = dto;
                _chartLabels = dto.Categories.Select(c => c.Name).ToArray();
                var data = dto.Categories.Select(c => (double)c.Amount).ToArray();
                _chartDatasets = new[] { new MudBlazor.ChartSeries { Name = "Gastos", Data = data } };
                // ensure UI updates
                StateHasChanged();
            }
            else
            {
                // API returned unauthorized or no data — redirect to login
                Navigation.NavigateTo("/login");
                return;
            }
        }
        catch
        {
            // ignore
        }
    }

    
}
