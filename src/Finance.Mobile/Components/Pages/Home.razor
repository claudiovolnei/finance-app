@page "/"
@implements IDisposable
@using Finance.Mobile.Components.Charts
@using Finance.Mobile.Services
@using Finance.Domain.Entities

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <MonthYearNavigator CurrentLabel="@GetCurrentFilterLabel()" OnPrevious="PrevMonth" OnNext="NextMonth" />
    <MudGrid GutterSize="GutterSize.Small" AlignItems="Center">
        <MudItem xs="12" sm="12">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Saldo Atual</MudText>
                <MudText Typo="Typo.h5" Class="fluid-value" Color="_summary?.Balance > 0 ? Color.Success : Color.Error">@(_summary is null ? "-" : string.Format(new System.Globalization.CultureInfo("pt-BR"), "{0:C}", _summary.Balance))</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="6">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Receitas</MudText>
                <MudText Typo="Typo.h5" Class="fluid-value" Color="Color.Success">@(_summary is null ? "-" : string.Format(new System.Globalization.CultureInfo("pt-BR"), "{0:C}", _summary.TotalIncome))</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="6">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Despesas</MudText>
                <MudText Typo="Typo.h5" Class="fluid-value" Color="Color.Error">@(_summary is null ? "-" : string.Format(new System.Globalization.CultureInfo("pt-BR"), "{0:C}", _summary.TotalExpense))</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" class="mt-3">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Categorias por tipo</MudText>
                <CategoryBarChart Labels="@_chartLabels" Values="@_chartDataRaw" Types="@_chartTypes" EmptyMessage="Sem dados" />
            </MudPaper>
        </MudItem>

        <MudItem xs="12" class="mt-3">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Últimos Lançamentos</MudText>

                @if (_summary is null)
                {
                    <MudSkeleton Height="44px" Class="mb-2" />
                    <MudSkeleton Height="44px" Class="mb-2" />
                    <MudSkeleton Height="44px" />
                }
                else if (!_summary.LatestTransactions.Any())
                {
                    <MudAlert Severity="Severity.Info" Dense="true">Sem lançamentos no período.</MudAlert>
                }
                else
                {
                    <MudList T="TransactionSummaryDto"
                            Dense="true"
                             Class="pa-0">
                        @foreach (var tx in _summary.LatestTransactions)
                        {
                            <MudListItem Class="px-0" Button="true" OnClick="@(() => OpenTransactionDialog(tx))">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width:100%;">
                                    <MudStack Spacing="0" Style="min-width:0;">
                                        <MudText Typo="Typo.body2" Class="list-primary-text">@tx.CategoryName</MudText>
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary list-secondary-text">@tx.Date.ToString("dd/MM/yyyy")</MudText>
                                    </MudStack>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudChip T="string" Color="@(tx.Type == TransactionType.Income ? Color.Success : Color.Error)" Variant="Variant.Text" Size="Size.Small">
                                            @(tx.Type == TransactionType.Income ? "Crédito" : "Débito")
                                        </MudChip>
                                        <MudText Typo="Typo.body2" Class="list-value-text" Color="@(tx.Type == TransactionType.Income ? Color.Success : Color.Error)">
                                            @string.Format(new System.Globalization.CultureInfo("pt-BR"), "{0:C}", tx.Amount)
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@if (_isTransactionPanelVisible && _selectedTransaction is not null)
{
    <div class="transaction-detail-overlay" @onclick="CloseTransactionDialogAsync">
        <MudPaper Class="@GetTransactionPanelClass()" Elevation="6" @onclick:stopPropagation="true">
            <MudStack Spacing="3">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Class="transaction-detail-subtitle">Resumo do lançamento</MudText>
                    </MudStack>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small" OnClick="CloseTransactionDialogAsync" />
                </MudStack>

                <MudPaper Class="transaction-highlight-card" Elevation="0">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Valor da transação</MudText>
                            <MudText Typo="Typo.h5" Color="@GetTransactionColor(_selectedTransaction.Type)">
                                @string.Format(new System.Globalization.CultureInfo("pt-BR"), "{0:C}", _selectedTransaction.Amount)
                            </MudText>
                        </MudStack>
                        <MudChip T="string"
                                 Color="@GetTransactionColor(_selectedTransaction.Type)"
                                 Variant="Variant.Filled"
                                 Size="Size.Small">
                            @(_selectedTransaction.Type == TransactionType.Income ? "Receita" : "Despesa")
                        </MudChip>
                    </MudStack>
                </MudPaper>

                <MudGrid Class="transaction-detail-grid" GutterSize="GutterSize.Small">
                    <MudItem xs="12" sm="6">
                        <MudPaper Class="transaction-detail-item" Elevation="0">
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Categoria</MudText>
                            <MudText Typo="Typo.body1">@_selectedTransaction.CategoryName</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudPaper Class="transaction-detail-item" Elevation="0">
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Data</MudText>
                            <MudText Typo="Typo.body1">@_selectedTransaction.Date.ToString("dd/MM/yyyy")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12">
                        <MudPaper Class="transaction-detail-item" Elevation="0">
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">Descrição</MudText>
                            <MudText Typo="Typo.body1">@(string.IsNullOrWhiteSpace(_selectedTransaction.Description) ? "Sem descrição informada" : _selectedTransaction.Description)</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <MudDivider />

                <MudText Typo="Typo.caption" Class="mud-text-secondary">Referência da transação #@_selectedTransaction.Id</MudText>
            </MudStack>
        </MudPaper>
    </div>
}

@code {
    [Inject] public FinanceApiClient Api { get; set; } = default!;
    [Inject] public TokenService TokenService { get; set; } = default!;
    [Inject] public AccountSelectionState AccountState { get; set; } = default!;
    [Inject] public NavigationManager Navigation { get; set; } = default!;

    private DashboardSummaryDto? _summary;
    private string[] _chartLabels = Array.Empty<string>();
    private double[] _chartDataRaw = Array.Empty<double>();
    private TransactionType[] _chartTypes = Array.Empty<TransactionType>();
    private int? _filterYear;
    private int? _filterMonth;
    private DateTime _current = DateTime.Now;
    private TransactionSummaryDto? _selectedTransaction;
    private bool _isTransactionDialogOpen;
    private bool _isTransactionPanelVisible;
    private const int TransactionPanelAnimationMs = 260;

    protected override async Task OnInitializedAsync()
    {
        AccountState.OnChange += HandleAccountChanged;

        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        Api.SetBearerToken(token);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;

        await LoadSummaryAsync();
    }

    private string GetCurrentFilterLabel() => _current.ToString("MMMM yyyy", new System.Globalization.CultureInfo("pt-BR"));

    private async Task PrevMonth()
    {
        _current = _current.AddMonths(-1);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;
        await LoadSummaryAsync();
    }

    private async Task NextMonth()
    {
        _current = _current.AddMonths(1);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;
        await LoadSummaryAsync();
    }

    private async Task LoadSummaryAsync()
    {
        try
        {
            var dto = await Api.GetDashboardSummaryAsync(_filterYear, _filterMonth, AccountState.SelectedAccountId);
            if (dto == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            _summary = dto;
            _chartLabels = dto.Categories.Select(c => c.Name).ToArray();
            _chartDataRaw = dto.Categories.Select(c => (double)c.Amount).ToArray();
            _chartTypes = dto.Categories.Select(c => c.Type).ToArray();
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // ignore
        }
    }

    private async void HandleAccountChanged()
    {
        await InvokeAsync(async () =>
        {
            _current = DateTime.Now;
            _filterYear = _current.Year;
            _filterMonth = _current.Month;
            await LoadSummaryAsync();
            StateHasChanged();
        });
    }

    private void OpenTransactionDialog(TransactionSummaryDto transaction)
    {
        _selectedTransaction = transaction;
        _isTransactionPanelVisible = true;
        _isTransactionDialogOpen = true;
    }

    private async Task CloseTransactionDialogAsync()
    {
        _isTransactionDialogOpen = false;
        await InvokeAsync(StateHasChanged);
        await Task.Delay(TransactionPanelAnimationMs);
        _isTransactionPanelVisible = false;
        _selectedTransaction = null;
    }

    private string GetTransactionPanelClass() =>
        _isTransactionDialogOpen
            ? "transaction-detail-dialog transaction-detail-dialog-open"
            : "transaction-detail-dialog transaction-detail-dialog-close";

    private Color GetTransactionColor(TransactionType type) =>
        type == TransactionType.Income ? Color.Success : Color.Error;

    public void Dispose()
    {
        AccountState.OnChange -= HandleAccountChanged;
    }
}
