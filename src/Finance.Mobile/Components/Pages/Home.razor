@page "/"
@implements IDisposable
@using Finance.Mobile.Components.Charts
@using Finance.Mobile.Services

<MudItem xs="12" class="mt-2">
    <div style="display:flex;justify-content:center;align-items:center;gap:12px;">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIos" OnClick="PrevMonth" />
        <MudText Typo="Typo.subtitle1">@GetCurrentFilterLabel()</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.ArrowForwardIos" OnClick="NextMonth" />
    </div>
</MudItem>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <MudGrid GutterSize="GutterSize.Small" AlignItems="Center">
        <MudItem xs="12" sm="12">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Saldo Atual</MudText>
                <MudText Typo="Typo.h5" Color="_summary?.Balance > 0 ? Color.Success : Color.Error">@(_summary is null ? "-" : string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", _summary.Balance))</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="6">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Receitas</MudText>
                <MudText Typo="Typo.h5" Color="Color.Primary">@(_summary is null ? "-" : string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", _summary.TotalIncome))</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="6">
            <MudPaper Class="pa-4 card-center" Elevation="1">
                <MudText Typo="Typo.subtitle1">Despesas</MudText>
                <MudText Typo="Typo.h5" Color="Color.Error">@(_summary is null ? "-" : string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", _summary.TotalExpense))</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" class="mt-3">
            <MudPaper Class="pa-4">
                <CategoryBarChart Labels="@_chartLabels" Values="@_chartDataRaw" EmptyMessage="Sem dados" />
            </MudPaper>
        </MudItem>

        <MudItem xs="12" class="mt-3">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.subtitle1">Últimos Lançamentos</MudText>
                <div style="overflow:auto;margin-top:8px;">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="text-align:left;border-bottom:1px solid rgba(0,0,0,0.08);">
                                <th style="padding:8px;">Data</th>
                                <th style="padding:8px;">Categoria</th>
                                <th style="padding:8px;">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if (_summary != null)
                        {
                            foreach (var tx in _summary.LatestTransactions)
                            {
                                <tr>
                                    <td style="padding:8px;">@tx.Date.ToString("dd/MM/yyyy")</td>
                                    <td style="padding:8px;">@tx.CategoryName</td>
                                    <td style="padding:8px;">@string.Format(System.Globalization.CultureInfo.CurrentCulture, "{0:C}", tx.Amount)</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="4" style="padding:8px;">Carregando...</td></tr>
                        }
                        </tbody>
                    </table>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    [Inject] public FinanceApiClient Api { get; set; } = default!;
    [Inject] public TokenService TokenService { get; set; } = default!;
    [Inject] public AccountSelectionState AccountState { get; set; } = default!;
    [Inject] public NavigationManager Navigation { get; set; } = default!;

    private DashboardSummaryDto? _summary;
    private string[] _chartLabels = Array.Empty<string>();
    private double[] _chartDataRaw = Array.Empty<double>();
    private int? _filterYear;
    private int? _filterMonth;
    private DateTime _current = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        AccountState.OnChange += HandleAccountChanged;

        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        Api.SetBearerToken(token);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;

        await LoadSummaryAsync();
    }

    private string GetCurrentFilterLabel() => _current.ToString("MMMM yyyy", System.Globalization.CultureInfo.CurrentCulture);

    private async Task PrevMonth()
    {
        _current = _current.AddMonths(-1);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;
        await LoadSummaryAsync();
    }

    private async Task NextMonth()
    {
        _current = _current.AddMonths(1);
        _filterYear = _current.Year;
        _filterMonth = _current.Month;
        await LoadSummaryAsync();
    }

    private async Task LoadSummaryAsync()
    {
        try
        {
            var dto = await Api.GetDashboardSummaryAsync(_filterYear, _filterMonth, AccountState.SelectedAccountId);
            if (dto == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            _summary = dto;
            _chartLabels = dto.Categories.Select(c => c.Name).ToArray();
            _chartDataRaw = dto.Categories.Select(c => Math.Abs((double)c.Amount)).ToArray();
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // ignore
        }
    }

    private async void HandleAccountChanged()
    {
        await LoadSummaryAsync();
    }

    public void Dispose()
    {
        AccountState.OnChange -= HandleAccountChanged;
    }
}
