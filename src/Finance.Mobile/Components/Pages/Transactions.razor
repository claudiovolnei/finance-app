@page "/transactions"
@implements IDisposable
@using MudBlazor
@using Finance.Domain.Entities
@using Finance.Mobile.Services
@inject FinanceApiClient ApiClient
@inject NavigationManager Navigation
@inject TokenService TokenService
@inject AccountSelectionState AccountState

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Transações</MudText>

    <MudPaper Class="pa-3 mb-4">
        <MudGrid GutterSize="GutterSize.Small">
            <MudItem xs="12" sm="4">
                <MudSelect T="int?" Value="_selectedAccountId" ValueChanged="OnAccountChanged" Label="Conta" Dense="true" Variant="Variant.Outlined">
                    <MudSelectItem T="int?" Value="@((int?)null)">Todas</MudSelectItem>
                    @foreach (var account in AccountState.Accounts)
                    {
                        <MudSelectItem T="int?" Value="@((int?)account.Id)">@account.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="6" sm="4">
                <MudSelect T="int?" Value="_filterYear" ValueChanged="OnYearChanged" Label="Ano" Dense="true" Variant="Variant.Outlined">
                    <MudSelectItem T="int?" Value="@((int?)null)">Todos</MudSelectItem>
                    @foreach (var year in _availableYears)
                    {
                        <MudSelectItem T="int?" Value="@year">@year</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="6" sm="4">
                <MudSelect T="int?" Value="_filterMonth" ValueChanged="OnMonthChanged" Label="Mês" Dense="true" Variant="Variant.Outlined">
                    <MudSelectItem T="int?" Value="@((int?)null)">Todos</MudSelectItem>
                    @foreach (var month in _months)
                    {
                        <MudSelectItem T="int?" Value="@month">@new DateTime(2000, month, 1).ToString("MMMM")</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="NavigateToAdd" Class="mb-4">
        Nova Transação
    </MudButton>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (_transactions == null || !_transactions.Any())
    {
        <MudAlert Severity="Severity.Info">Nenhuma transação encontrada.</MudAlert>
    }
    else
    {
        <MudTable Items="@_transactions" Hover="true" Dense="true" Striped="true">
            <HeaderContent>
                <MudTh>Data</MudTh>
                <MudTh>Categoria</MudTh>
                <MudTh>Valor</MudTh>
                <MudTh>Tipo</MudTh>
                <MudTh>Ações</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Data">@context.Date.ToString("dd/MM/yyyy")</MudTd>
                <MudTd DataLabel="Categoria">@context.CategoryName</MudTd>
                <MudTd DataLabel="Valor">@context.Amount.ToString("C")</MudTd>
                <MudTd DataLabel="Tipo">
                    <MudChip T="string" Color="@(context.Type == TransactionType.Income ? Color.Success : Color.Error)" Size="Size.Small">
                        @context.Type.ToString()
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Ações">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => NavigateToEdit(context.Id))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteTransaction(context.Id))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

    @if (!string.IsNullOrEmpty(_message))
    {
        <MudAlert Severity="@_alertSeverity" Class="mt-4">@_message</MudAlert>
    }
</MudContainer>

@code {
    private List<TransactionDto>? _transactions;
    private bool _loading = true;
    private string _message = "";
    private Severity _alertSeverity = Severity.Info;
    private int? _selectedAccountId;
    private int? _filterYear;
    private int? _filterMonth;
    private readonly int[] _months = Enumerable.Range(1, 12).ToArray();
    private int[] _availableYears = Array.Empty<int>();

    protected override async Task OnInitializedAsync()
    {
        AccountState.OnChange += HandleGlobalAccountChanged;

        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        ApiClient.SetBearerToken(token);
        _selectedAccountId = AccountState.SelectedAccountId;

        await LoadTransactions();
    }

    private async Task LoadTransactions()
    {
        try
        {
            _loading = true;
            _transactions = await ApiClient.GetTransactionsAsync(_filterYear, _filterMonth, _selectedAccountId);
            _availableYears = _transactions.Select(t => t.Date.Year).Distinct().OrderByDescending(y => y).ToArray();
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        catch (Exception ex)
        {
            _message = $"Erro ao carregar transações: {ex.Message}";
            _alertSeverity = Severity.Error;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnAccountChanged(int? value)
    {
        _selectedAccountId = value;
        AccountState.SetSelectedAccount(value);
        await LoadTransactions();
    }

    private async Task OnYearChanged(int? value)
    {
        _filterYear = value;
        await LoadTransactions();
    }

    private async Task OnMonthChanged(int? value)
    {
        _filterMonth = value;
        await LoadTransactions();
    }

    private async void NavigateToAdd()
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }
        Navigation.NavigateTo("/transactions/add");
    }

    private void NavigateToEdit(int id)
    {
        _ = EnsureAndNavigateEdit(id);
    }

    private async Task EnsureAndNavigateEdit(int id)
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }
        Navigation.NavigateTo($"/transactions/edit/{id}");
    }

    private async Task DeleteTransaction(int id)
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        try
        {
            await ApiClient.DeleteTransactionAsync(id);
            _message = "Transação excluída com sucesso!";
            _alertSeverity = Severity.Success;
            await LoadTransactions();
        }
        catch (Exception ex)
        {
            _message = $"Erro ao excluir transação: {ex.Message}";
            _alertSeverity = Severity.Error;
        }
    }

    private async void HandleGlobalAccountChanged()
    {
        _selectedAccountId = AccountState.SelectedAccountId;
        await LoadTransactions();
    }

    public void Dispose()
    {
        AccountState.OnChange -= HandleGlobalAccountChanged;
    }
}
