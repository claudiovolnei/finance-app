@page "/categories"
@using MudBlazor
@using Finance.Domain.Entities
@using Finance.Mobile.Services
@inject FinanceApiClient ApiClient
@inject NavigationManager Navigation
@inject TokenService TokenService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Categorias</MudText>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="NavigateToAdd" Class="mb-4">
        Nova Categoria
    </MudButton>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (_categories == null || !_categories.Any())
    {
        <MudAlert Severity="Severity.Info">Nenhuma categoria encontrada.</MudAlert>
    }
    else
    {
        <MudTable Items="@_categories" Hover="true" Dense="true" Striped="true">
            <HeaderContent>
                <MudTh>Nome</MudTh>
                <MudTh>Ações</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Nome">@context.Name</MudTd>
                <MudTd DataLabel="Ações">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => NavigateToEdit(context.Id))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteCategory(context.Id))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

    @if (!string.IsNullOrEmpty(_message))
    {
        <MudAlert Severity="@_alertSeverity" Class="mt-4">@_message</MudAlert>
    }
</MudContainer>

@code {
    private List<Category>? _categories;
    private bool _loading = true;
    private string _message = "";
    private Severity _alertSeverity = Severity.Info;

    protected override async Task OnInitializedAsync()
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        try
        {
            _loading = true;
            _categories = await ApiClient.GetCategoriesAsync();
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        catch (Exception ex)
        {
            _message = $"Erro ao carregar categorias: {ex.Message}";
            _alertSeverity = Severity.Error;
        }
        finally
        {
            _loading = false;
        }
    }

    private async void NavigateToAdd()
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }
        Navigation.NavigateTo("/categories/add");
    }

    private void NavigateToEdit(int id)
    {
        _ = EnsureAndNavigateEdit(id);
    }

    private async Task EnsureAndNavigateEdit(int id)
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }
        Navigation.NavigateTo($"/categories/edit/{id}");
    }

    private async Task DeleteCategory(int id)
    {
        var token = await TokenService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        try
        {
            await ApiClient.DeleteCategoryAsync(id);
            _message = "Categoria excluída com sucesso!";
            _alertSeverity = Severity.Success;
            await LoadCategories();
        }
        catch (UnauthorizedAccessException)
        {
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            _message = $"Erro ao excluir categoria: {ex.Message}";
            _alertSeverity = Severity.Error;
        }
    }
}
